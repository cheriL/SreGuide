<template><h1 id="深入理解-kubelet-中的-pleg-is-not-healthy" tabindex="-1"><a class="header-anchor" href="#深入理解-kubelet-中的-pleg-is-not-healthy" aria-hidden="true">#</a> 深入理解 Kubelet 中的 PLEG is not healthy</h1>
<blockquote>
<p>转载自：<a href="https://fuckcloudnative.io/posts/understanding-the-pleg-is-not-healthy/" target="_blank" rel="noopener noreferrer">深入理解 Kubelet 中的 PLEG is not healthy | 米开朗基杨<ExternalLinkIcon/></a></p>
</blockquote>
<p>在 Kubernetes 社区中，<strong>PLEG is not healthy</strong> 成名已久，只要出现这个报错，就有很大概率造成 Node 状态变成 <code>NotReady</code>。社区相关的 issue 也有一大把，先列几个给你们看看：</p>
<ul>
<li>https://stackoverflow.com/questions/53872739/how-to-fix-container-runtime-is-down-pleg-is-not-healthy</li>
<li>https://github.com/kubernetes/kubernetes/issues/45419</li>
<li>https://github.com/kubernetes/kubernetes/issues/61117</li>
<li>https://github.com/kubernetes/kubernetes/issues/72533</li>
<li>https://github.com/Azure/AKS/issues/102</li>
</ul>
<p>本文我将尝试解释 PLEG 的工作原理，只要理解了工作原理，再遇到类似的问题就有排查思路了。</p>
<h2 id="_1-pleg-是个啥" tabindex="-1"><a class="header-anchor" href="#_1-pleg-是个啥" aria-hidden="true">#</a> 1. PLEG 是个啥？</h2>
<hr>
<p>PLEG 全称叫 <code>Pod Lifecycle Event Generator</code>，即 Pod 生命周期事件生成器。实际上它只是 <code>Kubelet</code> 中的一个模块，主要职责就是通过每个匹配的 Pod 级别事件来调整容器运行时的状态，并将调整的结果写入缓存，使 <code>Pod</code> 的缓存保持最新状态。先来聊聊 PLEG 的出现背景。</p>
<p>在 Kubernetes 中，每个节点上都运行着一个守护进程 <code>Kubelet</code> 来管理节点上的容器，调整容器的实际状态以匹配 <code>spec</code> 中定义的状态。具体来说，Kubelet 需要对两个地方的更改做出及时的回应：</p>
<ol>
<li>Pod spec 中定义的状态</li>
<li>容器运行时的状态</li>
</ol>
<p>对于 Pod，Kubelet 会从多个数据来源 <code>watch</code> Pod spec 中的变化。对于容器，Kubelet 会定期（例如，10s）轮询容器运行时，以获取所有容器的最新状态。</p>
<p>随着 Pod 和容器数量的增加，轮询会产生不可忽略的开销，并且会由于 Kubelet 的并行操作而加剧这种开销（为每个 Pod 分配一个 <code>goruntine</code>，用来获取容器的状态）。轮询带来的周期性大量并发请求会导致较高的 CPU 使用率峰值（即使 Pod 的定义和容器的状态没有发生改变），降低性能。最后容器运行时可能不堪重负，从而降低系统的可靠性，限制 Kubelet 的可扩展性。</p>
<p>为了降低 Pod 的管理开销，提升 Kubelet 的性能和可扩展性，引入了 PLEG，改进了之前的工作方式：</p>
<ul>
<li>减少空闲期间的不必要工作（例如 Pod 的定义和容器的状态没有发生更改）。</li>
<li>减少获取容器状态的并发请求数量。</li>
</ul>
<p>整体的工作流程如下图所示，虚线部分是 PLEG 的工作内容。</p>
<p><img src="https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/orig-pleg-1.png" alt="img" loading="lazy"></p>
<h2 id="_2-pleg-is-not-healthy-是如何发生的" tabindex="-1"><a class="header-anchor" href="#_2-pleg-is-not-healthy-是如何发生的" aria-hidden="true">#</a> 2. PLEG is not healthy 是如何发生的？</h2>
<hr>
<p><code>Healthy()</code> 函数会以 “PLEG” 的形式添加到 <code>runtimeState</code> 中，Kubelet 在一个同步循环（<code>SyncLoop()</code> 函数）中会定期（默认是 10s）调用 <code>Healthy()</code> 函数。<code>Healthy()</code> 函数会检查 <code>relist</code> 进程（PLEG 的关键任务）是否在 3 分钟内完成。如果 relist 进程的完成时间超过了 3 分钟，就会报告 <strong>PLEG is not healthy</strong>。</p>
<p><img src="https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/pleg-healthy-checks.png" alt="img" loading="lazy"></p>
<p>我会在流程的每一步通过源代码解释其相关的工作原理，源代码基于 Kubernetes 1.11（Openshift 3.11）。如果你不熟悉 Go 的语法也不用担心，只需要看代码中的注释就能明白其原理。我也会在放出代码之前先解读一番，并从源代码中裁剪掉不太重要的内容以提高代码的可读性。下面是调用 healthy() 函数的相关代码：</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">//// pkg/kubelet/pleg/generic.go - Healthy()</span>

<span class="token comment">// The threshold needs to be greater than the relisting period + the</span>
<span class="token comment">// relisting time, which can vary significantly. Set a conservative</span>
<span class="token comment">// threshold to avoid flipping between healthy and unhealthy.</span>
relistThreshold <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute
<span class="token punctuation">:</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>GenericPLEG<span class="token punctuation">)</span> <span class="token function">Healthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  relistTime <span class="token operator">:=</span> g<span class="token punctuation">.</span><span class="token function">getRelistTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  elapsed <span class="token operator">:=</span> g<span class="token punctuation">.</span>clock<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>relistTime<span class="token punctuation">)</span>
  <span class="token keyword">if</span> elapsed <span class="token operator">></span> relistThreshold <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"pleg was last seen active %v ago; threshold is %v"</span><span class="token punctuation">,</span> elapsed<span class="token punctuation">,</span> relistThreshold<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">//// pkg/kubelet/kubelet.go - NewMainKubelet()</span>
<span class="token keyword">func</span> <span class="token function">NewMainKubelet</span><span class="token punctuation">(</span>kubeCfg <span class="token operator">*</span>kubeletconfiginternal<span class="token punctuation">.</span>KubeletConfiguration<span class="token punctuation">,</span> <span class="token operator">...</span>
<span class="token punctuation">:</span>
  klet<span class="token punctuation">.</span>runtimeState<span class="token punctuation">.</span><span class="token function">addHealthCheck</span><span class="token punctuation">(</span><span class="token string">"PLEG"</span><span class="token punctuation">,</span> klet<span class="token punctuation">.</span>pleg<span class="token punctuation">.</span>Healthy<span class="token punctuation">)</span>

<span class="token comment">//// pkg/kubelet/kubelet.go - syncLoop()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>kl <span class="token operator">*</span>Kubelet<span class="token punctuation">)</span> <span class="token function">syncLoop</span><span class="token punctuation">(</span>updates <span class="token operator">&lt;-</span><span class="token keyword">chan</span> kubetypes<span class="token punctuation">.</span>PodUpdate<span class="token punctuation">,</span> handler SyncHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">:</span>
<span class="token comment">// The resyncTicker wakes up kubelet to checks if there are any pod workers</span>
<span class="token comment">// that need to be sync'd. A one-second period is sufficient because the</span>
<span class="token comment">// sync interval is defaulted to 10s.</span>
<span class="token punctuation">:</span>
  <span class="token keyword">const</span> <span class="token punctuation">(</span>
    base   <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond
    max    <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second
    factor <span class="token operator">=</span> <span class="token number">2</span>
  <span class="token punctuation">)</span>
  duration <span class="token operator">:=</span> base
  <span class="token keyword">for</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> rs <span class="token operator">:=</span> kl<span class="token punctuation">.</span>runtimeState<span class="token punctuation">.</span><span class="token function">runtimeErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">len</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
          glog<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"skipping pod synchronization - %v"</span><span class="token punctuation">,</span> rs<span class="token punctuation">)</span>
          <span class="token comment">// exponential backoff</span>
          time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span>
          duration <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span><span class="token function">Min</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">,</span> factor<span class="token operator">*</span><span class="token function">float64</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">continue</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">:</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">:</span>
<span class="token punctuation">}</span>

<span class="token comment">//// pkg/kubelet/runtime.go - runtimeErrors()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>runtimeState<span class="token punctuation">)</span> <span class="token function">runtimeErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>
<span class="token punctuation">:</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> hc <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>healthChecks <span class="token punctuation">{</span>
        <span class="token keyword">if</span> ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> hc<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            ret <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s is not healthy: %v"</span><span class="token punctuation">,</span> hc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">:</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><h2 id="_3-深入解读-relist-函数" tabindex="-1"><a class="header-anchor" href="#_3-深入解读-relist-函数" aria-hidden="true">#</a> 3. 深入解读 relist 函数</h2>
<hr>
<p>上文提到 <code>healthy()</code> 函数会检查 relist 的完成时间，但 relist 究竟是用来干嘛的呢？解释 relist 之前，要先解释一下 Pod 的生命周期事件。Pod 的生命周期事件是在 Pod 层面上对底层容器状态改变的抽象，使其与底层的容器运行时无关，这样就可以让 Kubelet 不受底层容器运行时的影响。</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> PodLifeCycleEventType <span class="token builtin">string</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
    ContainerStarted      PodLifeCycleEventType <span class="token operator">=</span> <span class="token string">"ContainerStarted"</span>
    ContainerStopped      PodLifeCycleEventType <span class="token operator">=</span> <span class="token string">"ContainerStopped"</span>
    NetworkSetupCompleted PodLifeCycleEventType <span class="token operator">=</span> <span class="token string">"NetworkSetupCompleted"</span>
    NetworkFailed         PodLifeCycleEventType <span class="token operator">=</span> <span class="token string">"NetworkFailed"</span>
<span class="token punctuation">)</span>

<span class="token comment">// PodLifecycleEvent is an event reflects the change of the pod state.</span>
<span class="token keyword">type</span> PodLifecycleEvent <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// The pod ID.</span>
    ID types<span class="token punctuation">.</span>UID
    <span class="token comment">// The type of the event.</span>
    Type PodLifeCycleEventType
    <span class="token comment">// The accompanied data which varies based on the event type.</span>
    Data <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>以 Docker 为例，在 Pod 中启动一个 infra 容器就会在 Kubelet 中注册一个 <code>NetworkSetupCompleted</code> Pod 生命周期事件。</p>
<p>那么 PLEG 是如何知道新启动了一个 infra 容器呢？它会定期重新列出节点上的所有容器（例如 docker ps），并与上一次的容器列表进行对比，以此来判断容器状态的变化。其实这就是 <code>relist()</code> 函数干的事情，尽管这种方法和以前的 Kubelet 轮询类似，但现在只有一个线程，就是 PLEG。现在不需要所有的线程并发获取容器的状态，只有相关的线程会被唤醒用来同步容器状态。而且 relist 与容器运行时无关，也不需要外部依赖，简直完美。</p>
<p>下面我们来看一下 <code>relist()</code> 函数的内部实现。完整的流程如下图所示：</p>
<p><img src="https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/pleg-process.png" alt="img" loading="lazy"></p>
<p>注意图中的 RPC 调用部分，后文将会拎出来详细解读。完整的源代码在<a href="https://github.com/openshift/origin/blob/release-3.11/vendor/k8s.io/kubernetes/pkg/kubelet/pleg/generic.go#L180-L284" target="_blank" rel="noopener noreferrer">这里<ExternalLinkIcon/></a>。</p>
<p>尽管每秒钟调用一次 <code>relist</code>，但它的完成时间仍然有可能超过 1s。因为下一次调用 <code>relist</code> 必须得等上一次 relist 执行结束，设想一下，如果容器运行时响应缓慢，或者一个周期内有大量的容器状态发生改变，那么 <code>relist</code> 的完成时间将不可忽略，假设是 5s，那么下一次调用 <code>relist</code> 将要等到 6s 之后。</p>
<p><img src="https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/pleg-start-relist.png" alt="img" loading="lazy"></p>
<p>相关的源代码如下：</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">//// pkg/kubelet/kubelet.go - NewMainKubelet()</span>

<span class="token comment">// Generic PLEG relies on relisting for discovering container events.</span>
<span class="token comment">// A longer period means that kubelet will take longer to detect container</span>
<span class="token comment">// changes and to update pod status. On the other hand, a shorter period</span>
<span class="token comment">// will cause more frequent relisting (e.g., container runtime operations),</span>
<span class="token comment">// leading to higher cpu usage.</span>
<span class="token comment">// Note that even though we set the period to 1s, the relisting itself can</span>
<span class="token comment">// take more than 1s to finish if the container runtime responds slowly</span>
<span class="token comment">// and/or when there are many container changes in one cycle.</span>
plegRelistPeriod <span class="token operator">=</span> time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">1</span>

<span class="token comment">// NewMainKubelet instantiates a new Kubelet object along with all the required internal modules.</span>
<span class="token comment">// No initialization of Kubelet and its modules should happen here.</span>
<span class="token keyword">func</span> <span class="token function">NewMainKubelet</span><span class="token punctuation">(</span>kubeCfg <span class="token operator">*</span>kubeletconfiginternal<span class="token punctuation">.</span>KubeletConfiguration<span class="token punctuation">,</span> <span class="token operator">...</span>
<span class="token punctuation">:</span>
  klet<span class="token punctuation">.</span>pleg <span class="token operator">=</span> pleg<span class="token punctuation">.</span><span class="token function">NewGenericPLEG</span><span class="token punctuation">(</span>klet<span class="token punctuation">.</span>containerRuntime<span class="token punctuation">,</span> plegChannelCapacity<span class="token punctuation">,</span> plegRelistPeriod<span class="token punctuation">,</span> klet<span class="token punctuation">.</span>podCache<span class="token punctuation">,</span> clock<span class="token punctuation">.</span>RealClock<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//// pkg/kubelet/pleg/generic.go - Start()</span>

<span class="token comment">// Start spawns a goroutine to relist periodically.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>GenericPLEG<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">go</span> wait<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>relist<span class="token punctuation">,</span> g<span class="token punctuation">.</span>relistPeriod<span class="token punctuation">,</span> wait<span class="token punctuation">.</span>NeverStop<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//// pkg/kubelet/pleg/generic.go - relist()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>GenericPLEG<span class="token punctuation">)</span> <span class="token function">relist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">...</span> WE WILL REVIEW HERE <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>回到上面那幅图，relist 函数第一步就是记录 <code>Kubelet</code> 的相关指标（例如 <code>kubelet_pleg_relist_latency_microseconds</code>），然后通过 CRI 从容器运行时获取当前的 Pod 列表（包括停止的 Pod）。该 Pod 列表会和之前的 Pod 列表进行比较，检查哪些状态发生了变化，然后同时生成相关的 <strong>Pod 生命周期事件</strong>和<strong>更改后的状态</strong>。</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">//// pkg/kubelet/pleg/generic.go - relist()</span>
  <span class="token punctuation">:</span>
  <span class="token comment">// get a current timestamp</span>
  timestamp <span class="token operator">:=</span> g<span class="token punctuation">.</span>clock<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// kubelet_pleg_relist_latency_microseconds for prometheus metrics</span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        metrics<span class="token punctuation">.</span>PLEGRelistLatency<span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInMicroseconds</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// Get all the pods.</span>
    podList<span class="token punctuation">,</span> err <span class="token operator">:=</span> g<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">GetPods</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">:</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>其中 <code>GetPods()</code> 函数的调用堆栈如下图所示：</p>
<p><img src="/Users/wangzhi4/Downloads/tmp/pleg-getpods.png" alt="img" loading="lazy"></p>
<p>相关的源代码如下：</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">//// pkg/kubelet/kuberuntime/kuberuntime_manager.go - GetPods()</span>

<span class="token comment">// GetPods returns a list of containers grouped by pods. The boolean parameter</span>
<span class="token comment">// specifies whether the runtime returns all containers including those already</span>
<span class="token comment">// exited and dead containers (used for garbage collection).</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>kubeGenericRuntimeManager<span class="token punctuation">)</span> <span class="token function">GetPods</span><span class="token punctuation">(</span>all <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>kubecontainer<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pods <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>kubetypes<span class="token punctuation">.</span>UID<span class="token punctuation">]</span><span class="token operator">*</span>kubecontainer<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span>
    sandboxes<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">getKubeletSandboxes</span><span class="token punctuation">(</span>all<span class="token punctuation">)</span>
<span class="token punctuation">:</span>
<span class="token punctuation">}</span>

<span class="token comment">//// pkg/kubelet/kuberuntime/kuberuntime_sandbox.go - getKubeletSandboxes()</span>

<span class="token comment">// getKubeletSandboxes lists all (or just the running) sandboxes managed by kubelet.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>kubeGenericRuntimeManager<span class="token punctuation">)</span> <span class="token function">getKubeletSandboxes</span><span class="token punctuation">(</span>all <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>runtimeapi<span class="token punctuation">.</span>PodSandbox<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">:</span>
    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span>runtimeService<span class="token punctuation">.</span><span class="token function">ListPodSandbox</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span>
<span class="token punctuation">:</span>
<span class="token punctuation">}</span>

<span class="token comment">//// pkg/kubelet/remote/remote_runtime.go - ListPodSandbox()</span>

<span class="token comment">// ListPodSandbox returns a list of PodSandboxes.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RemoteRuntimeService<span class="token punctuation">)</span> <span class="token function">ListPodSandbox</span><span class="token punctuation">(</span>filter <span class="token operator">*</span>runtimeapi<span class="token punctuation">.</span>PodSandboxFilter<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>runtimeapi<span class="token punctuation">.</span>PodSandbox<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">:</span>
    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>runtimeClient<span class="token punctuation">.</span><span class="token function">ListPodSandbox</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>runtimeapi<span class="token punctuation">.</span>ListPodSandboxRequest<span class="token punctuation">{</span>
<span class="token punctuation">:</span>
    <span class="token keyword">return</span> resp<span class="token punctuation">.</span>Items<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>获取所有的 Pod 列表后，<code>relist</code> 的完成时间就会更新成当前的时间戳。也就是说，<code>Healthy()</code> 函数可以根据这个时间戳来评估 relist 是否超过了 3 分钟。</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">//// pkg/kubelet/pleg/generic.go - relist()</span>

  <span class="token comment">// update as a current timestamp</span>
  g<span class="token punctuation">.</span><span class="token function">updateRelistTime</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>将当前的 Pod 列表和上一次 relist 的 Pod 列表进行对比之后，就会针对每一个变化生成相应的 Pod 级别的事件。相关的源代码如下：</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">//// pkg/kubelet/pleg/generic.go - relist()</span>

  pods <span class="token operator">:=</span> kubecontainer<span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span>podList<span class="token punctuation">)</span>
  g<span class="token punctuation">.</span>podRecords<span class="token punctuation">.</span><span class="token function">setCurrent</span><span class="token punctuation">(</span>pods<span class="token punctuation">)</span>

  <span class="token comment">// Compare the old and the current pods, and generate events.</span>
  eventsByPodID <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span>types<span class="token punctuation">.</span>UID<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>PodLifecycleEvent<span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">for</span> pid <span class="token operator">:=</span> <span class="token keyword">range</span> g<span class="token punctuation">.</span>podRecords <span class="token punctuation">{</span>
    oldPod <span class="token operator">:=</span> g<span class="token punctuation">.</span>podRecords<span class="token punctuation">.</span><span class="token function">getOld</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span>
    pod <span class="token operator">:=</span> g<span class="token punctuation">.</span>podRecords<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span>

    <span class="token comment">// Get all containers in the old and the new pod.</span>
    allContainers <span class="token operator">:=</span> <span class="token function">getContainersFromPods</span><span class="token punctuation">(</span>oldPod<span class="token punctuation">,</span> pod<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> container <span class="token operator">:=</span> <span class="token keyword">range</span> allContainers <span class="token punctuation">{</span>
          events <span class="token operator">:=</span> <span class="token function">computeEvents</span><span class="token punctuation">(</span>oldPod<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> <span class="token operator">&amp;</span>container<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>

          <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> e <span class="token operator">:=</span> <span class="token keyword">range</span> events <span class="token punctuation">{</span>
                <span class="token function">updateEvents</span><span class="token punctuation">(</span>eventsByPodID<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>其中 <code>generateEvents()</code> 函数（<code>computeEvents()</code> 函数会调用它）用来生成相应的 Pod 级别的事件（例如 <code>ContainerStarted</code>、<code>ContainerDied</code> 等等），然后通过 <code>updateEvents()</code> 函数来更新事件。</p>
<p><code>computeEvents()</code> 函数的内容如下：</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">//// pkg/kubelet/pleg/generic.go - computeEvents()</span>

<span class="token keyword">func</span> <span class="token function">computeEvents</span><span class="token punctuation">(</span>oldPod<span class="token punctuation">,</span> newPod <span class="token operator">*</span>kubecontainer<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> cid <span class="token operator">*</span>kubecontainer<span class="token punctuation">.</span>ContainerID<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>PodLifecycleEvent <span class="token punctuation">{</span>
<span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token function">generateEvents</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> cid<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> oldState<span class="token punctuation">,</span> newState<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//// pkg/kubelet/pleg/generic.go - generateEvents()</span>

<span class="token keyword">func</span> <span class="token function">generateEvents</span><span class="token punctuation">(</span>podID types<span class="token punctuation">.</span>UID<span class="token punctuation">,</span> cid <span class="token builtin">string</span><span class="token punctuation">,</span> oldState<span class="token punctuation">,</span> newState plegContainerState<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>PodLifecycleEvent <span class="token punctuation">{</span>
<span class="token punctuation">:</span>
    glog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"GenericPLEG: %v/%v: %v -> %v"</span><span class="token punctuation">,</span> podID<span class="token punctuation">,</span> cid<span class="token punctuation">,</span> oldState<span class="token punctuation">,</span> newState<span class="token punctuation">)</span>
    <span class="token keyword">switch</span> newState <span class="token punctuation">{</span>
    <span class="token keyword">case</span> plegContainerRunning<span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>PodLifecycleEvent<span class="token punctuation">{</span><span class="token punctuation">{</span>ID<span class="token punctuation">:</span> podID<span class="token punctuation">,</span> Type<span class="token punctuation">:</span> ContainerStarted<span class="token punctuation">,</span> Data<span class="token punctuation">:</span> cid<span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token keyword">case</span> plegContainerExited<span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>PodLifecycleEvent<span class="token punctuation">{</span><span class="token punctuation">{</span>ID<span class="token punctuation">:</span> podID<span class="token punctuation">,</span> Type<span class="token punctuation">:</span> ContainerDied<span class="token punctuation">,</span> Data<span class="token punctuation">:</span> cid<span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token keyword">case</span> plegContainerUnknown<span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>PodLifecycleEvent<span class="token punctuation">{</span><span class="token punctuation">{</span>ID<span class="token punctuation">:</span> podID<span class="token punctuation">,</span> Type<span class="token punctuation">:</span> ContainerChanged<span class="token punctuation">,</span> Data<span class="token punctuation">:</span> cid<span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token keyword">case</span> plegContainerNonExistent<span class="token punctuation">:</span>
      <span class="token keyword">switch</span> oldState <span class="token punctuation">{</span>
      <span class="token keyword">case</span> plegContainerExited<span class="token punctuation">:</span>
        <span class="token comment">// We already reported that the container died before.</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>PodLifecycleEvent<span class="token punctuation">{</span><span class="token punctuation">{</span>ID<span class="token punctuation">:</span> podID<span class="token punctuation">,</span> Type<span class="token punctuation">:</span> ContainerRemoved<span class="token punctuation">,</span> Data<span class="token punctuation">:</span> cid<span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>PodLifecycleEvent<span class="token punctuation">{</span><span class="token punctuation">{</span>ID<span class="token punctuation">:</span> podID<span class="token punctuation">,</span> Type<span class="token punctuation">:</span> ContainerDied<span class="token punctuation">,</span> Data<span class="token punctuation">:</span> cid<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>ID<span class="token punctuation">:</span> podID<span class="token punctuation">,</span> Type<span class="token punctuation">:</span> ContainerRemoved<span class="token punctuation">,</span> Data<span class="token punctuation">:</span> cid<span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
      <span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"unrecognized container state: %v"</span><span class="token punctuation">,</span> newState<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>relist 的最后一个任务是检查是否有与 Pod 关联的事件，并按照下面的流程更新 <code>podCache</code>。</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">//// pkg/kubelet/pleg/generic.go - relist()</span>

  <span class="token comment">// If there are events associated with a pod, we should update the</span>
  <span class="token comment">// podCache.</span>
  <span class="token keyword">for</span> pid<span class="token punctuation">,</span> events <span class="token operator">:=</span> <span class="token keyword">range</span> eventsByPodID <span class="token punctuation">{</span>
    pod <span class="token operator">:=</span> g<span class="token punctuation">.</span>podRecords<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span>
    <span class="token keyword">if</span> g<span class="token punctuation">.</span><span class="token function">cacheEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// updateCache() will inspect the pod and update the cache. If an</span>
      <span class="token comment">// error occurs during the inspection, we want PLEG to retry again</span>
      <span class="token comment">// in the next relist. To achieve this, we do not update the</span>
      <span class="token comment">// associated podRecord of the pod, so that the change will be</span>
      <span class="token comment">// detect again in the next relist.</span>
      <span class="token comment">// TODO: If many pods changed during the same relist period,</span>
      <span class="token comment">// inspecting the pod and getting the PodStatus to update the cache</span>
      <span class="token comment">// serially may take a while. We should be aware of this and</span>
      <span class="token comment">// parallelize if needed.</span>
      <span class="token keyword">if</span> err <span class="token operator">:=</span> g<span class="token punctuation">.</span><span class="token function">updateCache</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        glog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"PLEG: Ignoring events for pod %s/%s: %v"</span><span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">:</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">:</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Update the internal storage and send out the events.</span>
    g<span class="token punctuation">.</span>podRecords<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> events <span class="token punctuation">{</span>
      <span class="token comment">// Filter out events that are not reliable and no other components use yet.</span>
      <span class="token keyword">if</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Type <span class="token operator">==</span> ContainerChanged <span class="token punctuation">{</span>
           <span class="token keyword">continue</span>
      <span class="token punctuation">}</span>
      g<span class="token punctuation">.</span>eventChannel <span class="token operator">&lt;-</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p><code>updateCache()</code> 将会检查每个 Pod，并在单个循环中依次对其进行更新。因此，如果在同一个 relist 中更改了大量的 Pod，那么 updateCache 过程将会成为瓶颈。最后，更新后的 Pod 生命周期事件将会被发送到 <code>eventChannel</code>。</p>
<p>某些远程客户端还会调用每一个 Pod 来获取 Pod 的 spec 定义信息，这样一来，Pod 数量越多，延时就可能越高，因为 Pod 越多就会生成越多的事件。</p>
<p><code>updateCache()</code> 的详细调用堆栈如下图所示，其中 <code>GetPodStatus()</code> 用来获取 Pod 的 spec 定义信息：</p>
<p><img src="https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/pleg-updatecache.png" alt="img" loading="lazy"></p>
<p>完整的代码如下：</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">//// pkg/kubelet/pleg/generic.go - updateCache()</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>GenericPLEG<span class="token punctuation">)</span> <span class="token function">updateCache</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>kubecontainer<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> pid types<span class="token punctuation">.</span>UID<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
<span class="token punctuation">:</span>
    timestamp <span class="token operator">:=</span> g<span class="token punctuation">.</span>clock<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// TODO: Consider adding a new runtime method</span>
    <span class="token comment">// GetPodStatus(pod *kubecontainer.Pod) so that Docker can avoid listing</span>
    <span class="token comment">// all containers again.</span>
    status<span class="token punctuation">,</span> err <span class="token operator">:=</span> g<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">GetPodStatus</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span>
  <span class="token punctuation">:</span>
    g<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> status<span class="token punctuation">,</span> err<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>

<span class="token comment">//// pkg/kubelet/kuberuntime/kuberuntime_manager.go - GetPodStatus()</span>

<span class="token comment">// GetPodStatus retrieves the status of the pod, including the</span>
<span class="token comment">// information of all containers in the pod that are visible in Runtime.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>kubeGenericRuntimeManager<span class="token punctuation">)</span> <span class="token function">GetPodStatus</span><span class="token punctuation">(</span>uid kubetypes<span class="token punctuation">.</span>UID<span class="token punctuation">,</span> name<span class="token punctuation">,</span> namespace <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>kubecontainer<span class="token punctuation">.</span>PodStatus<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  podSandboxIDs<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">getSandboxIDByPodUID</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
  <span class="token punctuation">:</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> podSandboxID <span class="token operator">:=</span> <span class="token keyword">range</span> podSandboxIDs <span class="token punctuation">{</span>
        podSandboxStatus<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span>runtimeService<span class="token punctuation">.</span><span class="token function">PodSandboxStatus</span><span class="token punctuation">(</span>podSandboxID<span class="token punctuation">)</span>
    <span class="token punctuation">:</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Get statuses of all containers visible in the pod.</span>
    containerStatuses<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">getPodContainerStatuses</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> name<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span>
  <span class="token punctuation">:</span>
<span class="token punctuation">}</span>

<span class="token comment">//// pkg/kubelet/kuberuntime/kuberuntime_sandbox.go - getSandboxIDByPodUID()</span>

<span class="token comment">// getPodSandboxID gets the sandbox id by podUID and returns ([]sandboxID, error).</span>
<span class="token comment">// Param state could be nil in order to get all sandboxes belonging to same pod.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>kubeGenericRuntimeManager<span class="token punctuation">)</span> <span class="token function">getSandboxIDByPodUID</span><span class="token punctuation">(</span>podUID kubetypes<span class="token punctuation">.</span>UID<span class="token punctuation">,</span> state <span class="token operator">*</span>runtimeapi<span class="token punctuation">.</span>PodSandboxState<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">:</span>
  sandboxes<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span>runtimeService<span class="token punctuation">.</span><span class="token function">ListPodSandbox</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span>
  <span class="token punctuation">:</span>  
  <span class="token keyword">return</span> sandboxIDs<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">//// pkg/kubelet/remote/remote_runtime.go - PodSandboxStatus()</span>

<span class="token comment">// PodSandboxStatus returns the status of the PodSandbox.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RemoteRuntimeService<span class="token punctuation">)</span> <span class="token function">PodSandboxStatus</span><span class="token punctuation">(</span>podSandBoxID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>runtimeapi<span class="token punctuation">.</span>PodSandboxStatus<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> <span class="token function">getContextWithTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>runtimeClient<span class="token punctuation">.</span><span class="token function">PodSandboxStatus</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>runtimeapi<span class="token punctuation">.</span>PodSandboxStatusRequest<span class="token punctuation">{</span>
        PodSandboxId<span class="token punctuation">:</span> podSandBoxID<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">:</span>
    <span class="token keyword">return</span> resp<span class="token punctuation">.</span>Status<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">//// pkg/kubelet/kuberuntime/kuberuntime_container.go - getPodContainerStatuses()</span>

<span class="token comment">// getPodContainerStatuses gets all containers' statuses for the pod.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>kubeGenericRuntimeManager<span class="token punctuation">)</span> <span class="token function">getPodContainerStatuses</span><span class="token punctuation">(</span>uid kubetypes<span class="token punctuation">.</span>UID<span class="token punctuation">,</span> name<span class="token punctuation">,</span> namespace <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>kubecontainer<span class="token punctuation">.</span>ContainerStatus<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Select all containers of the given pod.</span>
  containers<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span>runtimeService<span class="token punctuation">.</span><span class="token function">ListContainers</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>runtimeapi<span class="token punctuation">.</span>ContainerFilter<span class="token punctuation">{</span>
    LabelSelector<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>types<span class="token punctuation">.</span>KubernetesPodUIDLabel<span class="token punctuation">:</span> <span class="token function">string</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">:</span>
  <span class="token comment">// TODO: optimization: set maximum number of containers per container name to examine.</span>
  <span class="token keyword">for</span> i<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> containers <span class="token punctuation">{</span>
    status<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span>runtimeService<span class="token punctuation">.</span><span class="token function">ContainerStatus</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>
    <span class="token punctuation">:</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">:</span>
  <span class="token keyword">return</span> statuses<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><p>上面就是 relist() 函数的完整调用堆栈，我在讲解的过程中结合了相关的源代码，希望能为你提供有关 PLEG 的更多细节。为了实时了解 PLEG 的健康状况，最好的办法就是监控 relist。</p>
<h2 id="_4-监控-relist" tabindex="-1"><a class="header-anchor" href="#_4-监控-relist" aria-hidden="true">#</a> 4. 监控 relist</h2>
<hr>
<p>我们可以通过监控 Kubelet 的指标来了解 <code>relist</code> 的延时。<code>relist</code> 的调用周期是 1s，那么 <strong>relist 的完成时间 + 1s</strong> 就等于 <code>kubelet_pleg_relist_interval_microseconds</code> 指标的值。你也可以监控容器运行时每个操作的延时，这些指标在排查故障时都能提供线索。</p>
<p><img src="https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/pleg-kubelet-metrics-table.png" alt="img" loading="lazy"></p>
<p>你可以在每个节点上通过访问 URL <code>https://127.0.0.1:10250/metrics</code> 来获取 Kubelet 的指标。</p>
<div class="language-promql ext-promql line-numbers-mode"><pre v-pre class="language-promql"><code><span class="token comment"># HELP kubelet_pleg_relist_interval_microseconds Interval in microseconds between relisting in PLEG.</span>
<span class="token comment"># TYPE kubelet_pleg_relist_interval_microseconds summary</span>
kubelet_pleg_relist_interval_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.5"</span><span class="token punctuation">}</span></span> <span class="token number">1.054052e+06</span>
kubelet_pleg_relist_interval_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.9"</span><span class="token punctuation">}</span></span> <span class="token number">1.074873e+06</span>
kubelet_pleg_relist_interval_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.99"</span><span class="token punctuation">}</span></span> <span class="token number">1.126039e+06</span>
kubelet_pleg_relist_interval_microseconds_count <span class="token number">5146</span>

<span class="token comment"># HELP kubelet_pleg_relist_latency_microseconds Latency in microseconds for relisting pods in PLEG.</span>
<span class="token comment"># TYPE kubelet_pleg_relist_latency_microseconds summary</span>
kubelet_pleg_relist_latency_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.5"</span><span class="token punctuation">}</span></span> <span class="token number">53438</span>
kubelet_pleg_relist_latency_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.9"</span><span class="token punctuation">}</span></span> <span class="token number">74396</span>
kubelet_pleg_relist_latency_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.99"</span><span class="token punctuation">}</span></span> <span class="token number">115232</span>
kubelet_pleg_relist_latency_microseconds_count <span class="token number">5106</span>

<span class="token comment"># HELP kubelet_runtime_operations Cumulative number of runtime operations by operation type.</span>
<span class="token comment"># TYPE kubelet_runtime_operations counter</span>
kubelet_runtime_operations<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"container_status"</span><span class="token punctuation">}</span></span> <span class="token number">472</span>
kubelet_runtime_operations<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"create_container"</span><span class="token punctuation">}</span></span> <span class="token number">93</span>
kubelet_runtime_operations<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"exec"</span><span class="token punctuation">}</span></span> <span class="token number">1</span>
kubelet_runtime_operations<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"exec_sync"</span><span class="token punctuation">}</span></span> <span class="token number">533</span>
kubelet_runtime_operations<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"image_status"</span><span class="token punctuation">}</span></span> <span class="token number">579</span>
kubelet_runtime_operations<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"list_containers"</span><span class="token punctuation">}</span></span> <span class="token number">10249</span>
kubelet_runtime_operations<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"list_images"</span><span class="token punctuation">}</span></span> <span class="token number">782</span>
kubelet_runtime_operations<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"list_podsandbox"</span><span class="token punctuation">}</span></span> <span class="token number">10154</span>
kubelet_runtime_operations<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"podsandbox_status"</span><span class="token punctuation">}</span></span> <span class="token number">315</span>
kubelet_runtime_operations<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"pull_image"</span><span class="token punctuation">}</span></span> <span class="token number">57</span>
kubelet_runtime_operations<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"remove_container"</span><span class="token punctuation">}</span></span> <span class="token number">49</span>
kubelet_runtime_operations<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"run_podsandbox"</span><span class="token punctuation">}</span></span> <span class="token number">28</span>
kubelet_runtime_operations<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"start_container"</span><span class="token punctuation">}</span></span> <span class="token number">93</span>
kubelet_runtime_operations<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"status"</span><span class="token punctuation">}</span></span> <span class="token number">1116</span>
kubelet_runtime_operations<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"stop_container"</span><span class="token punctuation">}</span></span> <span class="token number">9</span>
kubelet_runtime_operations<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"stop_podsandbox"</span><span class="token punctuation">}</span></span> <span class="token number">33</span>
kubelet_runtime_operations<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"version"</span><span class="token punctuation">}</span></span> <span class="token number">564</span>

<span class="token comment"># HELP kubelet_runtime_operations_latency_microseconds Latency in microseconds of runtime operations. Broken down by operation type.</span>
<span class="token comment"># TYPE kubelet_runtime_operations_latency_microseconds summary</span>
kubelet_runtime_operations_latency_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"container_status"</span><span class="token punctuation">,</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.5"</span><span class="token punctuation">}</span></span> <span class="token number">12117</span>
kubelet_runtime_operations_latency_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"container_status"</span><span class="token punctuation">,</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.9"</span><span class="token punctuation">}</span></span> <span class="token number">26607</span>
kubelet_runtime_operations_latency_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"container_status"</span><span class="token punctuation">,</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.99"</span><span class="token punctuation">}</span></span> <span class="token number">27598</span>
kubelet_runtime_operations_latency_microseconds_count<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"container_status"</span><span class="token punctuation">}</span></span> <span class="token number">486</span>
kubelet_runtime_operations_latency_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"list_containers"</span><span class="token punctuation">,</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.5"</span><span class="token punctuation">}</span></span> <span class="token number">29972</span>
kubelet_runtime_operations_latency_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"list_containers"</span><span class="token punctuation">,</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.9"</span><span class="token punctuation">}</span></span> <span class="token number">47907</span>
kubelet_runtime_operations_latency_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"list_containers"</span><span class="token punctuation">,</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.99"</span><span class="token punctuation">}</span></span> <span class="token number">80982</span>
kubelet_runtime_operations_latency_microseconds_count<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"list_containers"</span><span class="token punctuation">}</span></span> <span class="token number">10812</span>
kubelet_runtime_operations_latency_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"list_podsandbox"</span><span class="token punctuation">,</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.5"</span><span class="token punctuation">}</span></span> <span class="token number">18053</span>
kubelet_runtime_operations_latency_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"list_podsandbox"</span><span class="token punctuation">,</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.9"</span><span class="token punctuation">}</span></span> <span class="token number">28116</span>
kubelet_runtime_operations_latency_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"list_podsandbox"</span><span class="token punctuation">,</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.99"</span><span class="token punctuation">}</span></span> <span class="token number">68748</span>
kubelet_runtime_operations_latency_microseconds_count<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"list_podsandbox"</span><span class="token punctuation">}</span></span> <span class="token number">10712</span>
kubelet_runtime_operations_latency_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"podsandbox_status"</span><span class="token punctuation">,</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.5"</span><span class="token punctuation">}</span></span> <span class="token number">4918</span>
kubelet_runtime_operations_latency_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"podsandbox_status"</span><span class="token punctuation">,</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.9"</span><span class="token punctuation">}</span></span> <span class="token number">15671</span>
kubelet_runtime_operations_latency_microseconds<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"podsandbox_status"</span><span class="token punctuation">,</span><span class="token label-key attr-name">quantile</span><span class="token punctuation">=</span><span class="token label-value attr-value">"0.99"</span><span class="token punctuation">}</span></span> <span class="token number">18398</span>
kubelet_runtime_operations_latency_microseconds_count<span class="token context-labels"><span class="token punctuation">{</span><span class="token label-key attr-name">operation_type</span><span class="token punctuation">=</span><span class="token label-value attr-value">"podsandbox_status"</span><span class="token punctuation">}</span></span> <span class="token number">323</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>可以通过 Prometheus 对其进行监控：</p>
<p><img src="https://gitee.com/clay-wangzhi/blogImg/raw/master/blogImg/pleg-prometheus-metrics.png" alt="img" loading="lazy"></p>
<h2 id="_5-总结" tabindex="-1"><a class="header-anchor" href="#_5-总结" aria-hidden="true">#</a> 5. 总结</h2>
<hr>
<p>以我的经验，造成 <strong>PLEG is not healthy</strong> 的因素有很多，而且我相信还有更多潜在的因素我们还没有遇到过。我只提供几个我能想到的原因：</p>
<ul>
<li>RPC 调用过程中容器运行时响应超时（有可能是性能下降，死锁或者出现了 bug）。</li>
<li>节点上的 Pod 数量太多，导致 <code>relist</code> 无法在 3 分钟内完成。事件数量和延时与 Pod 数量成正比，与节点资源无关。</li>
<li><a href="https://github.com/kubernetes/kubernetes/issues/72482" target="_blank" rel="noopener noreferrer">relist 出现了死锁<ExternalLinkIcon/></a>，该 bug 已在 Kubernetes 1.14 中修复。</li>
<li>获取 Pod 的网络堆栈信息时 CNI 出现了 bug。</li>
</ul>
<h2 id="_6-参考资料" tabindex="-1"><a class="header-anchor" href="#_6-参考资料" aria-hidden="true">#</a> 6. 参考资料</h2>
<hr>
<ul>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/pod-lifecycle-event-generator.md" target="_blank" rel="noopener noreferrer">Kubelet: Pod Lifecycle Event Generator (PLEG)<ExternalLinkIcon/></a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/runtime-pod-cache.md" target="_blank" rel="noopener noreferrer">Kubelet: Runtime Pod Cache<ExternalLinkIcon/></a></li>
<li><a href="https://github.com/openshift/origin/blob/release-3.11/vendor/k8s.io/kubernetes/pkg/kubelet/pleg/generic.go#L180-L284" target="_blank" rel="noopener noreferrer">relist() in kubernetes/pkg/kubelet/pleg/generic.go<ExternalLinkIcon/></a></li>
<li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1486914#c16" target="_blank" rel="noopener noreferrer">Past bug about CNI — PLEG is not healthy error, node marked NotReady<ExternalLinkIcon/></a></li>
</ul>
</template>
