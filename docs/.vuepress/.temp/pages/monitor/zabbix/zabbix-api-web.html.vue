<template><div><h1 id="_7-用zabbix-api批量添加web监控" tabindex="-1"><a class="header-anchor" href="#_7-用zabbix-api批量添加web监控" aria-hidden="true">#</a> 7 用zabbix api批量添加web监控</h1>
<p>python脚本如下：</p>
<p><code v-pre>vim zabbix_agent.py</code></p>
<div class="language-python line-numbers-mode" data-ext="py"><pre v-pre class="language-python"><code><span class="token comment"># ~*~ coding:utf-8 ~*~</span>
<span class="token keyword">from</span> zabbix_api <span class="token keyword">import</span> ZabbixAPI
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> json

ZABBIX_SREVER <span class="token operator">=</span> <span class="token string">"http://192.168.162.122"</span>
USERNAME <span class="token operator">=</span> <span class="token string">"Admin"</span>
PASSWORD <span class="token operator">=</span> <span class="token string">"zabbix"</span>
<span class="token comment">#HOSTNAME = "sh_ylf_15"</span>
<span class="token comment">#HOSTNAME = "h5_web_monitor"</span>
HOSTNAME <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
urlname <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
url <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
delay <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>


<span class="token comment"># 登录</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>ZABBIX_SREVER<span class="token punctuation">,</span> USERNAME<span class="token punctuation">,</span> PASSWORD<span class="token punctuation">)</span><span class="token punctuation">:</span>
    zapi <span class="token operator">=</span> ZabbixAPI<span class="token punctuation">(</span>ZABBIX_SREVER<span class="token punctuation">)</span>
    zapi<span class="token punctuation">.</span>login<span class="token punctuation">(</span>USERNAME<span class="token punctuation">,</span> PASSWORD<span class="token punctuation">)</span>
    <span class="token keyword">return</span> zapi


<span class="token comment"># 获取主机id</span>
<span class="token keyword">def</span> <span class="token function">gethostid</span><span class="token punctuation">(</span>auth<span class="token punctuation">,</span> HOSTNAME<span class="token punctuation">)</span><span class="token punctuation">:</span>
    json_obj <span class="token operator">=</span> ZabbixAPI<span class="token punctuation">.</span>json_obj<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> <span class="token string">'host.get'</span><span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"filter"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"host"</span><span class="token punctuation">:</span> HOSTNAME<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    request <span class="token operator">=</span> ZabbixAPI<span class="token punctuation">.</span>do_request<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> json_obj<span class="token punctuation">)</span>

    <span class="token keyword">if</span> request<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> request<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'hostid'</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"找不到该主机"</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token comment"># 获取应用级id</span>
<span class="token keyword">def</span> <span class="token function">getapplicationid</span><span class="token punctuation">(</span>auth<span class="token punctuation">,</span> hostid<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># try:</span>
    <span class="token comment">#     json_obj = ZabbixAPI.json_obj(auth, 'application.create', params={"name": "Web监测","hostid": hostid})</span>
    <span class="token comment">#     ZabbixAPI.do_request(auth, json_obj)</span>
    <span class="token comment"># except Exception as e:</span>
    <span class="token comment">#     print(e)</span>
    json_obj <span class="token operator">=</span> ZabbixAPI<span class="token punctuation">.</span>json_obj<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> <span class="token string">'application.get'</span><span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"hostids"</span><span class="token punctuation">:</span> hostid<span class="token punctuation">}</span><span class="token punctuation">)</span>
    request <span class="token operator">=</span> ZabbixAPI<span class="token punctuation">.</span>do_request<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> json_obj<span class="token punctuation">)</span>
    <span class="token keyword">for</span> num <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>request<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> request<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'Web'</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> request<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'applicationid'</span><span class="token punctuation">]</span>


<span class="token comment"># 增加web监控</span>
<span class="token keyword">def</span> <span class="token function">create_web_scenario</span><span class="token punctuation">(</span>auth<span class="token punctuation">,</span> urlname<span class="token punctuation">,</span> url<span class="token punctuation">,</span> hostid<span class="token punctuation">,</span> applicationid<span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">:</span>
    json_obj <span class="token operator">=</span> ZabbixAPI<span class="token punctuation">.</span>json_obj<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> <span class="token string">'httptest.get'</span><span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"filter"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> urlname<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    request <span class="token operator">=</span> ZabbixAPI<span class="token punctuation">.</span>do_request<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> json_obj<span class="token punctuation">)</span>
    <span class="token keyword">if</span> request<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'该web监控已经添加过了'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            json_obj <span class="token operator">=</span> ZabbixAPI<span class="token punctuation">.</span>json_obj<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> <span class="token string">'httptest.create'</span><span class="token punctuation">,</span>
                                          params<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> urlname<span class="token punctuation">,</span> <span class="token string">"hostid"</span><span class="token punctuation">:</span> hostid<span class="token punctuation">,</span> <span class="token string">"applicationid"</span><span class="token punctuation">:</span> applicationid<span class="token punctuation">,</span>
                                                  <span class="token string">"delay"</span><span class="token punctuation">:</span> delay<span class="token punctuation">,</span> <span class="token string">"retries"</span><span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">"steps"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                                                  <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> urlname<span class="token punctuation">,</span> <span class="token string">'url'</span><span class="token punctuation">:</span> url<span class="token punctuation">,</span> <span class="token string">'timeout'</span><span class="token punctuation">:</span> <span class="token string">'10'</span><span class="token punctuation">,</span> <span class="token string">'status_codes'</span><span class="token punctuation">:</span> <span class="token string">'200'</span><span class="token punctuation">,</span>
                                                   <span class="token string">'no'</span><span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            ZabbixAPI<span class="token punctuation">.</span>do_request<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> json_obj<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token comment"># 增加触发器</span>
<span class="token keyword">def</span> <span class="token function">create_trigger</span><span class="token punctuation">(</span>auth<span class="token punctuation">,</span> HOSTNAME<span class="token punctuation">,</span> urlname<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    expression <span class="token operator">=</span> <span class="token string">"{"</span> <span class="token operator">+</span> <span class="token string">"{0}:web.test.fail[{1}].avg(#3)"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>HOSTNAME<span class="token punctuation">,</span> urlname<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"}"</span> <span class="token operator">+</span> <span class="token string">">=1"</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        json_obj <span class="token operator">=</span> ZabbixAPI<span class="token punctuation">.</span>json_obj<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> <span class="token string">'trigger.create'</span><span class="token punctuation">,</span>
                                      params<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"{0}访问失败"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>urlname<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"expression"</span><span class="token punctuation">:</span> expression<span class="token punctuation">,</span>
                                              <span class="token string">"priority"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"url"</span><span class="token punctuation">:</span> url<span class="token punctuation">}</span><span class="token punctuation">)</span>
        ZabbixAPI<span class="token punctuation">.</span>do_request<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> json_obj<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    expression <span class="token operator">=</span> <span class="token string">"{"</span> <span class="token operator">+</span> <span class="token string">"{0}:web.test.rspcode[{1},{1}].last(0)"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>HOSTNAME<span class="token punctuation">,</span> urlname<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"}"</span> <span class="token operator">+</span> <span class="token string">"&lt;>200"</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        json_obj <span class="token operator">=</span> ZabbixAPI<span class="token punctuation">.</span>json_obj<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> <span class="token string">'trigger.create'</span><span class="token punctuation">,</span>
                                      params<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"{0}访问异常"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>urlname<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"expression"</span><span class="token punctuation">:</span> expression<span class="token punctuation">,</span>
                                              <span class="token string">"priority"</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"url"</span><span class="token punctuation">:</span> url<span class="token punctuation">}</span><span class="token punctuation">)</span>
        ZabbixAPI<span class="token punctuation">.</span>do_request<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> json_obj<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token comment"># 获取监控项id</span>
<span class="token keyword">def</span> <span class="token function">getitem</span><span class="token punctuation">(</span>auth<span class="token punctuation">,</span> hostid<span class="token punctuation">,</span> urlname<span class="token punctuation">)</span><span class="token punctuation">:</span>
    json_obj <span class="token operator">=</span> ZabbixAPI<span class="token punctuation">.</span>json_obj<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> <span class="token string">'item.get'</span><span class="token punctuation">,</span>
                                  params<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"hostids"</span><span class="token punctuation">:</span> hostid<span class="token punctuation">,</span> <span class="token string">"webitems"</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
                                          <span class="token string">"filter"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Response code for step \"$2\" of scenario \"$1\"."</span><span class="token punctuation">,</span>
                                                     <span class="token string">"key_"</span><span class="token punctuation">:</span> <span class="token string">"web.test.rspcode[{0},{1}]"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>urlname<span class="token punctuation">,</span> urlname<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    request <span class="token operator">=</span> ZabbixAPI<span class="token punctuation">.</span>do_request<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> json_obj<span class="token punctuation">)</span>
    <span class="token keyword">return</span> request<span class="token punctuation">[</span><span class="token string">"result"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"itemid"</span><span class="token punctuation">]</span>


<span class="token comment"># 增加图形</span>
<span class="token keyword">def</span> <span class="token function">create_graph</span><span class="token punctuation">(</span>auth<span class="token punctuation">,</span> urlname<span class="token punctuation">,</span> hostid<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        itemid <span class="token operator">=</span> getitem<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> hostid<span class="token punctuation">,</span> urlname<span class="token punctuation">)</span>
        json_obj <span class="token operator">=</span> ZabbixAPI<span class="token punctuation">.</span>json_obj<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> <span class="token string">'graph.create'</span><span class="token punctuation">,</span>
                                      params<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"h5_{0}状态显示"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>urlname<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"width"</span><span class="token punctuation">:</span> <span class="token number">900</span><span class="token punctuation">,</span> <span class="token string">"height"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
                                              <span class="token string">"gitems"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"itemid"</span><span class="token punctuation">:</span> itemid<span class="token punctuation">,</span> <span class="token string">"color"</span><span class="token punctuation">:</span> <span class="token string">"008800"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        ZabbixAPI<span class="token punctuation">.</span>do_request<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> json_obj<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    auth <span class="token operator">=</span> login<span class="token punctuation">(</span>ZABBIX_SREVER<span class="token punctuation">,</span> USERNAME<span class="token punctuation">,</span> PASSWORD<span class="token punctuation">)</span>
    hostid <span class="token operator">=</span> gethostid<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> HOSTNAME<span class="token punctuation">)</span>
    applicationid <span class="token operator">=</span> getapplicationid<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> hostid<span class="token punctuation">)</span>

    create_web_scenario<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> urlname<span class="token punctuation">,</span> url<span class="token punctuation">,</span> hostid<span class="token punctuation">,</span> applicationid<span class="token punctuation">,</span> delay<span class="token punctuation">)</span>
    create_trigger<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> HOSTNAME<span class="token punctuation">,</span> urlname<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    create_graph<span class="token punctuation">(</span>auth<span class="token punctuation">,</span> urlname<span class="token punctuation">,</span> hostid<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># json_obj = ZabbixAPI.json_obj(auth, 'httptest.get', params={"applicationids": applicationid})</span>
<span class="token comment"># request = ZabbixAPI.do_request(auth, json_obj)</span>
<span class="token comment"># print(json.dumps(request, ensure_ascii=False, indent=4))</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编写shell，调用python，打日志</p>
<p><code v-pre>vim web_monitor.sh</code></p>
<div class="language-bash line-numbers-mode" data-ext="sh"><pre v-pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span><span class="token string">"en_US.UTF-8"</span>

<span class="token assign-left variable">arr_hostname</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">"192.168.165.115"</span> <span class="token string">"192.168.9.13"</span><span class="token punctuation">)</span>
<span class="token assign-left variable">len</span><span class="token operator">=</span><span class="token variable">${<span class="token operator">#</span>arr_hostname<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
<span class="token assign-left variable">dir</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">cd</span> <span class="token punctuation">$(</span>dirname $0<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>
<span class="token assign-left variable">tdir</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$dir</span>/tmp"</span>

<span class="token assign-left variable">dt</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> <span class="token string">"+%F %T"</span><span class="token variable">`</span></span>

<span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token variable">$tdir</span>/code_error.txt <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token boolean">true</span> <span class="token operator">></span><span class="token variable">$tdir</span>/code_error.txt

<span class="token comment">## i: 项目信息   j: url   k:时间间隔</span>
<span class="token keyword">while</span> <span class="token builtin class-name">read</span> i j k o<span class="token punctuation">;</span><span class="token keyword">do</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token operator">!</span> x<span class="token string">"<span class="token variable">$o</span>"</span> <span class="token operator">==</span> x<span class="token string">""</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$o</span> <span class="token parameter variable">-le</span> <span class="token variable"><span class="token variable">$((</span>$len<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-I</span> <span class="token string">"<span class="token variable">$j</span>"</span> <span class="token operator">></span> <span class="token variable">$tdir</span>/curl.txt
        <span class="token assign-left variable">code</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">grep</span> <span class="token string">'HTTP/1.1'</span> $tdir/curl.txt<span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'{print $2}'</span><span class="token variable">`</span></span>
        <span class="token comment">#echo "$i $j $code" </span>

        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$code</span> <span class="token parameter variable">-eq</span> <span class="token number">200</span> <span class="token parameter variable">-o</span> <span class="token variable">$code</span> <span class="token parameter variable">-eq</span> <span class="token number">301</span> <span class="token parameter variable">-o</span> <span class="token variable">$code</span> <span class="token parameter variable">-eq</span> <span class="token number">302</span> <span class="token parameter variable">-o</span> <span class="token variable">$code</span> <span class="token parameter variable">-eq</span> <span class="token number">405</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
            python <span class="token variable">$dir</span>/zabbix_agent.py <span class="token variable">$i</span> <span class="token variable">$j</span> <span class="token variable">$k</span> <span class="token variable">${arr_hostname<span class="token punctuation">[</span>$o<span class="token punctuation">]</span>}</span>
            <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$dt</span> <span class="token variable">$i</span> <span class="token variable">$j</span> <span class="token variable">$k</span> <span class="token variable">$o</span> create ok"</span> <span class="token operator">>></span> <span class="token variable">$tdir</span>/info <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$dt</span> <span class="token variable">$i</span> <span class="token variable">$j</span> <span class="token variable">$k</span> <span class="token variable">$o</span> create fail"</span> <span class="token operator">>></span><span class="token variable">$tdir</span>/info
        <span class="token keyword">else</span>
            <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$i</span> <span class="token variable">$j</span> <span class="token variable">$k</span> <span class="token variable">$o</span> <span class="token variable">$code</span>"</span> <span class="token operator">>></span><span class="token variable">$tdir</span>/code_error.txt
            <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$i</span> <span class="token variable">$code</span>"</span>
        <span class="token keyword">fi</span>
    <span class="token keyword">else</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"hostname参数传递错误"</span>
        <span class="token keyword">fi</span>
<span class="token keyword">done</span> <span class="token operator">&lt;</span><span class="token variable">$dir</span>/list
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>list</code>文件内容格式如下：</p>
<div class="language-text line-numbers-mode" data-ext="text"><pre v-pre class="language-text"><code>csp-web-syndata http://192.168.100.15:8085/csp-web-syndata/shop/synShopInfo/111 3m 0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote>
<p>参考链接：https://cloud.tencent.com/developer/article/1157571</p>
<p>https://www.zabbix.com/documentation/current/manual/api</p>
<p>https://segmentfault.com/a/1190000014241994</p>
</blockquote>
</div></template>


